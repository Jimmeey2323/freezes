<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Data Table</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        table {
            width: 90%;
            border-collapse: collapse;
            margin: 25px 0;
            font-size: 18px;
            text-align: left;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            background-color: #fff;
        }
        th, td {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #009879;
            color: white;
        }
        tr:hover {
            background-color: #f1f1f1;
        }
        caption {
            font-size: 24px;
            margin: 10px;
        }
    </style>
</head>
<body>

    <table id="data-table">
        <caption>Membership History</caption>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>History Type</th>
                <th>History Id</th>
                <th>Discount Code</th>
                <th>Member Name</th>
                <th>Membership Name</th>
                <th>Membership Id</th>
                <th>Member Id</th>
                <th>Bought Membership Id</th>
                <th>Host Id</th>
                <th>Start Date</th>
                <th>End Date</th>
                <th>Classes Left</th>
                <th>Usage Limit For Sessions</th>
                <th>Created At</th>
                <th>Payment Method</th>
                <th>Payment Source</th>
                <th>Freeze Attempts</th>
                <th>Frozen Days</th>
            </tr>
        </thead>
        <tbody>
            <!-- Data will be inserted here -->
        </tbody>
    </table>

    <script>
        async function fetchData() {
            const sessionCookie = "your-session-cookie"; // Replace with actual session cookie
            const memberIds = [123, 456, 789]; // Replace with actual member IDs
            const batchSize = 200;
            const historySheetData = [];

            for (let i = 0; i < memberIds.length; i += batchSize) {
                const batchMemberIds = memberIds.slice(i, i + batchSize);
                for (const memberId of batchMemberIds) {
                    const apiUrl = `https://readonly-api.momence.com/host/13752/customers/${memberId}/history`;
                    const response = await fetch(apiUrl, {
                        method: 'GET',
                        headers: {
                            'Cookie': sessionCookie,
                            'Accept': 'application/json',
                        }
                    });

                    const data = await response.json();
                    data.forEach(entry => {
                        if (entry.type === 'membership') {
                            const row = [
                                new Date(entry.timestamp).toLocaleString(), entry.type, entry.id, entry.discountCode || '-',
                                entry.memberName || '-', entry.membershipName || '-', entry.membershipId || '-', entry.memberId || '-',
                                entry.boughtMembershipId || '-', entry.hostId || '-', new Date(entry.startDate).toLocaleDateString() || '-',
                                new Date(entry.endDate).toLocaleDateString() || '-', entry.classesLeft || '-', entry.usageLimitForSessions || '-',
                                new Date(entry.createdAt).toLocaleString() || '-', entry.paymentMethod || '-', entry.paymentSource || '-',
                                0, 0 // Initialize freeze attempts and frozen days
                            ];

                            // Process activities for freeze/unfreeze
                            const freezeData = { freezeAttempts: 0, frozenDays: 0 };
                            if (entry.activities) {
                                let freezeStartDate = null;
                                entry.activities.forEach(activity => {
                                    if (activity.type === 'bought-membership-freezed') {
                                        freezeData.freezeAttempts++;
                                        freezeStartDate = new Date(activity.createdAt);
                                    } else if (activity.type === 'bought-membership-unfreezed' && freezeStartDate) {
                                        freezeData.frozenDays += Math.ceil((new Date(activity.createdAt) - freezeStartDate) / (1000 * 60 * 60 * 24));
                                        freezeStartDate = null;
                                    }
                                });
                            }
                            row[17] = freezeData.freezeAttempts;
                            row[18] = freezeData.frozenDays;

                            historySheetData.push(row);
                        }
                    });
                }
            }

            const tbody = document.querySelector("#data-table tbody");
            historySheetData.forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach(cellData => {
                    const cell = document.createElement('td');
                    cell.textContent = cellData;
                    row.appendChild(cell);
                });
                tbody.appendChild(row);
            });
        }

        document.addEventListener('DOMContentLoaded', fetchData);
    </script>

</body>
</html>
